---
title: "Depression"
author: "Ifrah Fayyaz"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(sqldf)

med_2020 = read_xlsx("Medical 2020.xlsx")
rx_2020 = read_xlsx("Rx 2020.xlsx")
hris = read_xlsx("HRIS.xlsx")
risk = read_xlsx("Risk 2020.xlsx")
```

## ICD-10 filtering
```{r}
depression = med_2020 %>% 
  mutate(keep = ifelse((str_detect(ICD10, paste(c("^F32", "^F33", "F03.90", "F34.1", "F43.21", "F06.31", "F06.32", "F25.1", "^F41", "R45.851"), collapse = "|"))),1,
                       ifelse((str_detect(CPT4, paste(c(as.character(99201:99205, 99211:99215, 90791, 90792, 90834, 90837, 90847)), collapse = "|"))),1,0))) %>%
  filter(keep == 1) %>%
  group_by(Person, From, To) %>%
  mutate(total_cost = sum(cost)) %>% 
  filter(total_cost > 0) %>%
  distinct(Person, From, To, .keep_all = TRUE) %>% 
  ungroup()
```

## Unique people
```{r}
people = sqldf("SELECT DISTINCT(Person), Gender, [Age Range]
               FROM depression")
```

## ER Visit
```{r}
er_visits = depression %>%
  filter(ER == 1)
```

## Gender
```{r}
sqldf("SELECT COUNT(Person), Gender
      FROM people
      GROUP BY Gender")
```

## Age Range
```{r}
sqldf("SELECT COUNT(Person), [Age Range]
      FROM people
      GROUP BY [Age Range]")
```

## POS
```{r}
sqldf("SELECT COUNT(Person), POS
      FROM depression
      GROUP BY POS")
```

## PCP Visit
```{r}
sqldf("SELECT COUNT(Person), PCP
      FROM depression
      WHERE PCP == 'Y'
      GROUP BY PCP")
```

## Length of stay
```{r}
los = depression %>%
  mutate(duration = To - From)
```

## Summary Statistics
```{r}
table(los$"Age Range", los$POS)
```

## RX
```{r}
supply = sqldf("SELECT DISTINCT Person, SUM(Days) AS supply, Class
       FROM rx_2020
       WHERE Class IN ('ANTIANXIETY AGENTS', 'ANTIDEPRESSANTS') AND Units > 0
       GROUP BY Person, Class")
```

## Merge (drugs and med)
```{r}
both = depression %>%
  inner_join(supply, by = "Person") %>%
  distinct(Person, .keep_all = T)
```

## Merge (all people)
```{r}
all_people = depression %>%
  full_join(supply, by = "Person") %>%
  distinct(Person, .keep_all = T)
```





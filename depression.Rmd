---
title: "Depression"
author: "Ifrah Fayyaz"
date: "2/14/2022"
output: html_document
---

<!-- big picture of the class of drugs - is depression important -->
<!-- take them under focus - total cost for people who took mental health services -->
<!-- 15% paid by employee, 85% by employer -->


```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(sqldf)
library(plotly)

med_2020 = read_xlsx("Medical 2020.xlsx") %>%
  janitor::clean_names()
rx_2020 = read_xlsx("Rx 2020.xlsx") %>%
  janitor::clean_names()
hris = read_xlsx("HRIS.xlsx") %>%
  janitor::clean_names()
risk = read_xlsx("Risk 2020.xlsx") %>%
  janitor::clean_names()

```

```{r}
all_depressed = med_2020 %>%
  str_detect(icd10, "^F", keep = 1) 
```


## ICD-10 filtering
```{r}
depression = med_2020 %>% 
  mutate(keep = ifelse((str_detect(icd10, paste(c("^F32", "^F33", "F03.90", "F34.1", "F43.21", "F06.31", "F06.32", "F25.1", "^F41", "R45.851"), collapse = "|"))),1,
                       ifelse((str_detect(cpt4, paste(c(as.character(99201:99205, 99211:99215, 90791, 90792, 90834, 90837, 90847)), collapse = "|"))),1,0))) %>%
  filter(keep == 1) %>%
  group_by(person, from, to) %>%
  mutate(total_cost = sum(cost)) %>% 
  filter(total_cost > 0) %>%
  distinct(person, from, to, .keep_all = TRUE) %>% 
  ungroup()
```

## Unique people
```{r}
people = sqldf("SELECT DISTINCT(person), gender, age_range
               FROM depression")
```

## ER Visit
```{r}
er_visits = depression %>%
  filter(er == 1)
```

## Gender
```{r}
sqldf("SELECT COUNT(person), gender
      FROM people
      GROUP BY gender")
```

## Age Range
```{r}
sqldf("SELECT COUNT(person), age_range
      FROM people
      GROUP BY age_range")
```

## POS
```{r}
sqldf("SELECT COUNT(person), pos
      FROM depression
      GROUP BY pos")
```

## PCP Visit
```{r}
sqldf("SELECT COUNT(person), pcp
      FROM depression
      WHERE pcp == 'Y'
      GROUP BY pcp")
```

## Length of stay
```{r}
los = depression %>%
  mutate(duration = to - from)
```

## Summary Statistics
```{r}
table(los$age_range, los$pos)
```

## RX
```{r}
supply = sqldf("SELECT DISTINCT person, SUM(days) AS supply, class
       FROM rx_2020
       WHERE class IN ('ANTIANXIETY AGENTS', 'ANTIDEPRESSANTS') AND Units > 0
       GROUP BY person, class")
```

## Merge (drugs and med)
```{r}
both = depression %>%
  inner_join(supply, by = "person") %>%
  distinct(person, .keep_all = T)
```

## Merge (all people)
```{r}
all_people = depression %>%
  full_join(supply, by = "person") %>%
  distinct(person, .keep_all = T)
```

## Pie for people on depression meds
```{r}
meds = sqldf("SELECT COUNT(DISTINCT(person)) AS total_people, class
       FROM rx_2020
       GROUP BY class")
  
  
dep_med = sqldf("SELECT total_people, class
       FROM meds
       ORDER BY total_people DESC
       LIMIT 5") 

others = sqldf("SELECT total_people, class
       FROM meds
       ORDER BY total_people
       LIMIT 74") 

others = sqldf("SELECT SUM(total_people) AS total_people
        FROM others") %>%
  mutate(class = "OTHERS")

pie_med = rbind(dep_med, others)

ggplot(pie_med, aes(x = "", y = total_people, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  theme_void()

```

## Supply of drugs
```{r}
supply = sqldf("SELECT class, SUM(Days) AS supply
       FROM rx_2020
       GROUP BY class
       HAVING supply > 0")

dep_supply = sqldf("SELECT supply, class
       FROM supply
       ORDER BY supply DESC
       LIMIT 5") 

anxiety = sqldf("SELECT supply, class
       FROM supply
       WHERE class == 'ANTIANXIETY AGENTS'")

other_supply = sqldf("SELECT supply, class
       FROM supply
       ORDER BY supply
       LIMIT 73") 

other_supply = sqldf("SELECT SUM(supply) AS supply
        FROM other_supply") %>%
  mutate(class = "OTHERS")

other_supply = mutate(supply = supply - 10093)

med_supply = rbind(dep_supply, anxiety, other_supply) %>%
  mutate(perc = `supply` / sum(`supply`)) %>% 
  mutate(labels = scales::percent(perc))

pie(med_supply$supply, med_supply$class)

ggplot(med_supply, aes(x = "", y = supply, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  theme_void()

ggplot(med_supply, aes(x = "", y = perc, fill = class)) +
  geom_col(color = "black") +
  geom_label(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE) +
  guides(fill = guide_legend(title = "Class")) +
  scale_fill_viridis_d() +
  coord_polar(theta = "y") + 
  theme_void()
```









